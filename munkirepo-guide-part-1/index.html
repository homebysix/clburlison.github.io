<!DOCTYPE html>
<!--[if lt IE 7]> <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]> <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]> <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Setup a Munki repo on Ubuntu 14.04 - Part 1  &middot; clburlison</title>
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1">


<meta name="description" content="" />

<meta name="keywords" content="munki, ubuntu, ">


<meta property="og:title" content="Setup a Munki repo on Ubuntu 14.04 - Part 1  &middot; clburlison ">
<meta property="og:site_name" content="clburlison"/>
<meta property="og:url" content="https://clburlison.com/munkirepo-guide-part-1/" />
<meta property="og:locale" content="en-EN">


<meta property="og:type" content="article" />
<meta property="og:description" content=""/>
<meta property="og:article:published_time" content="2014-10-06T00:00:00Z" />
<meta property="og:article:modified_time" content="2014-10-06T00:00:00Z" />

  
    
<meta property="og:article:tag" content="munki">
    
<meta property="og:article:tag" content="ubuntu">
    
  

  
<meta name="twitter:card" content="summary" />
<meta name="twitter:site" content="@clburlison" />
<meta name="twitter:creator" content="@clburlison" />
<meta name="twitter:title" content="Setup a Munki repo on Ubuntu 14.04 - Part 1" />
<meta name="twitter:description" content="" />
<meta name="twitter:url" content="https://clburlison.com/munkirepo-guide-part-1/" />
<meta name="twitter:domain" content="https://clburlison.com/">
  

<script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "Article",
    "headline": "Setup a Munki repo on Ubuntu 14.04 - Part 1",
    "author": {
      "@type": "Person",
      "name": "http://profiles.google.com/+?rel=author"
    },
    "datePublished": "2014-10-06",
    "description": "",
    "wordCount": 890
  }
</script>



<link rel="canonical" href="https://clburlison.com/munkirepo-guide-part-1/" />

<link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://clburlison.com/touch-icon-144-precomposed.png">
<link href="https://clburlison.com/favicon.png" rel="icon">

<meta name="generator" content="Hugo 0.20" />

  
<!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
<script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
<![endif]-->

<link href='https://fonts.googleapis.com/css?family=Merriweather:300%7CRaleway%7COpen+Sans' rel='stylesheet' type='text/css'>
<link rel="stylesheet" href="https://clburlison.com/css/font-awesome.min.css">
<link rel="stylesheet" href="https://clburlison.com/css/style.css">
<link rel="stylesheet" href="https://clburlison.com/css/highlight/default.css">

  
  
	<script>
	  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

	  ga('create', 'UA-49614309-2', 'auto');
	  ga('send', 'pageview');

	</script>

</head>
<body>
  <main id="main-wrapper" class="container main_wrapper has-sidebar">
    <header id="main-header" class="container main_header">
  <div class="container brand">
  <div class="container title h1-like">
  <a class="baselink" href="https://clburlison.com/">
  clburlison

</a>

</div>

  
<div class="container topline">
  
  A Mac sysadmin, documenting useful code, ideas, &amp; guides.


</div>


</div>

  <nav class="container nav primary no-print">
  

<a class="homelink" href="https://clburlison.com/">Home</a>


  
<a href="https://clburlison.com/about">About</a>

<a href="https://clburlison.com/post" title="Show list of posts">Posts</a>

<a href="https://clburlison.com/resources">Resources</a>

<a href="https://clburlison.com/tags" title="Show list of tags">Tags</a>

<a href="https://clburlison.com/talks">Talks</a>


</nav>

<div class="container nav secondary no-print">
  
<a id="contact-link-email" class="contact_link" href="mailto:clburlison@gmail.com">
  <span class="fa fa-envelope-square"></span><span>email</span></a>



<a id="contact-link-github" class="contact_link" href="https://github.com/clburlison">
  <span class="fa fa-github-square"></span><span>github</span></a>





<a id="contact-link-linkedin" class="contact_link" href="https://www.linkedin.com/in/clburlison">
  <span class="fa fa-linkedin-square"></span><span>linkedin</span></a>







<a id="contact-link-twitter" class="contact_link" href="https://twitter.com/clburlison">
  <span class="fa fa-twitter-square"></span><span>twitter</span></a>













</div>


  

</header>


<article id="main-content" class="container main_content single">
  <header class="container hat">
  <h1>Setup a Munki repo on Ubuntu 14.04 - Part 1
</h1>

  <div class="metas">
<time datetime="2014-10-06">Oct 06, 2014</time>


  
  &middot; Read in about 5 min
  &middot; (890 Words)
  <br>
  
<a class="label" href="https://clburlison.com/tags/munki">munki</a>

<a class="label" href="https://clburlison.com/tags/ubuntu">ubuntu</a>



</div>

</header>

  

<nav class="toc">
<input id="ac-toc" name="accordion-toc" type="checkbox">
<label for="ac-toc">Table of Contents</label>
<div id="toc" class="toc__menu">
<nav id="TableOfContents">
<ul>
<li><a href="#intro">Intro</a></li>
<li><a href="#the-install">The Install</a>
<ul>
<li><a href="#installing-required-software">Installing Required Software</a>
<ul>
<li><a href="#setup-the-directories">Setup the directories:</a></li>
<li><a href="#creating-the-service-accounts-set-directory-permissions">Creating the service accounts &amp; set directory permissions:</a></li>
</ul></li>
<li><a href="#setting-up-nginx">Setting up Nginx</a>
<ul>
<li><a href="#securing-your-munki-repo">Securing your munki_repo</a></li>
</ul></li>
<li><a href="#setting-up-samba">Setting up Samba</a></li>
</ul></li>
<li><a href="#conclusion">Conclusion</a></li>
</ul>
</nav>
</div>
</input>
</nav>



  <div class="container content">
  

<h1 id="intro">Intro</h1>

<p>As you might have guessed from my previous <a href="/blog/2014/10/02/reposado-guide/">post</a>, I am trying to standardize at work. Part of this was to move many core OS X services away from OS X Server and towards Ubuntu. This will allow us to use our existing virtualization infrastructure. After reposado the next big service was our munki repo.</p>

<p><img src="/images/2014-10-06/munki.jpg" alt="" /></p>

<p><a href="http://github.com/munki/munki" target="_blank">Munki</a> is a very powerful open source tool for patch management and software updates for OS X clients. The client component is pretty easy to install but the server component can be a bit more tricky for newer administrators. The goal of this guide is to walk through setting up the server web share with http basic authentication (read simply security), and lastly setup samba so we can remote into our web server to manage files.</p>

<p>In the past, our munki_repo has been shared using apache but due to some research and a few internal tests I will be using nginx as the backend in this guide.</p>

<p>Since our Munki setup has many add-on projects including: <a href="https://github.com/wollardj/Mandrill" target="_blank">mandrill</a>,  <a href="https://github.com/munkireport/munkireport-php/" target="_blank">munkireport-php</a>, and our in-house rsync replication I will be splitting this series into multiple parts.</p>

<p><img src="/images/2014-10-06/managed_software_center.png" alt="" /></p>

<h1 id="the-install">The Install</h1>

<p>It is good practice to make sure our Ubuntu server is fully patched before we start. Then we will install <em>git, curl, build-essential, nginx, apache2-utils, and samba</em>.</p>

<h2 id="installing-required-software">Installing Required Software</h2>

<pre><code class="language-bash">
sudo apt-get update
sudo apt-get upgrade
sudo apt-get -y install git curl build-essential nginx apache2-utils samba

</code></pre>

<h3 id="setup-the-directories">Setup the directories:</h3>

<pre><code class="language-bash">
sudo mkdir /usr/local/munki_repo
sudo mkdir -p /etc/nginx/sites-enabled/
ln -s /usr/local/munki_repo/ ~/
cd /usr/local/munki_repo
sudo mkdir catalogs client_resources icons manifests pkgs pkgsinfo

</code></pre>

<h3 id="creating-the-service-accounts-set-directory-permissions">Creating the service accounts &amp; set directory permissions:</h3>

<pre><code class="language-bash">
sudo addgroup --system munki
sudo adduser --system munki --ingroup munki
sudo usermod -a -G munki $USER # Adds the current console user to munki group
sudo usermod -a -G munki www-data # Adds web user to munki group
sudo chown -R $USER:munki /usr/local/munki_repo
sudo chmod -R 2774 /usr/local/munki_repo

</code></pre>

<h2 id="setting-up-nginx">Setting up Nginx</h2>

<p>Nginx is fast, light-weight, and uses a fraction of the resources that Apache uses. But don&rsquo;t take my word for it there are lots of <a href="http://arstechnica.com/business/2011/11/a-faster-web-server-ripping-out-apache-for-nginx/" target="_blank">other reason</a> why <a href="http://wiki.nginx.org/WhyUseIt" target="_blank">you might want to use Nginx</a>.</p>

<p>Nginx&rsquo;s installation on Ubuntu is very similar to Apache. All of its config files are stored in <em>/etc/nginx</em>.</p>

<p>Lets backup the original default file create and create our own.</p>

<pre><code class="language-bash">sudo mv /etc/nginx/sites-enabled/default ~/default.bkup
sudo nano /etc/nginx/sites-enabled/default
</code></pre>

<p>Make sure and change the server_name to match your server&rsquo;s Fully Qualified Domain Name (FQDN) or IP.</p>

<pre><code class="language-html">server {
  listen 80 default_server;
  listen [::]:80 default_server ipv6only=on;

  root /usr/share/nginx/html;
  index index.php index.html index.htm;

  server_name munki; # Change this to your FQDN.

  location /munki_repo/ {
    alias /usr/local/munki_repo/;
    autoindex off;
    auth_basic &quot;Restricted&quot;;
    auth_basic_user_file /etc/nginx/.htpasswd;
  }
}

</code></pre>

<p>And finally start the nginx service.<br />
<code>sudo /etc/init.d/nginx start</code></p>

<div class="alert alert-info">
  <p><strong>Nginx Issues:</strong> To have Nginx check your configuration for issues run the following command: <br> <code>nginx -c /etc/nginx/nginx.conf -t</code></p>

</div>


<h3 id="securing-your-munki-repo">Securing your munki_repo</h3>

<p>For my purpose, I will be securing my munki_repo with simple http basic authentication. Depending on the needs of your organization this might be enough but you might need to look into ssl and other advanced options. If you are interesting in these options check out the <a href="https://github.com/munki/munki/wiki" target="_blank">munki wiki</a>.</p>

<p><strong>Create an http user and password</strong>
<code>sudo htpasswd -c /etc/nginx/.htpasswd munkihttpuser</code></p>

<p>The tool will prompt you to enter a password (make it strong).</p>

<pre><code class="language-bash">
New password: ******
Re-type new password: ******
Adding password for user munkihttpuser

</code></pre>

<p>The structure of the htpasswd is <code>login:password_hash</code>.</p>

<p>We must reload the nginx service to update the reflected change.<br />
<code>sudo /etc/init.d/nginx reload</code></p>

<p>Now when you try to access your website, [<a href="http://yourmunkiserver/munki_repo/](" target="_blank">http://yourmunkiserver/munki_repo/](</a>), you will notice a browser prompt that asks you to enter the login and password. Enter the details that you used while creating the .htpasswd file. The prompt does not allow you to access the website until you enter the right credentials. The munki client supports this security feature with the AdditionalHttpHeaders key <a href="https://github.com/munki/munki/wiki/Using-Basic-Authentication#configuring-the-clients-to-use-a-password" target="_blank">more info</a>.</p>

<p>{<div class="alert alert-info">
  <p><strong>Note:</strong> If you do not want to secure your munki repo you can remove this setting in the above nginx config file by removing the two lines that start with <code>auth_basic</code></p>

</div>
</p>

<h2 id="setting-up-samba">Setting up Samba</h2>

<p>Now we just need a way to mount our munki_repo on a mac so we can do administrative things. Samba uses a separate set of passwords than the standard Linux system accounts (stored in /etc/samba/smbpasswd), so you&rsquo;ll need to create a Samba password for yourself.</p>

<pre><code class="language-bash">sudo smbpasswd -a munki
#output on the following lines
New SMB password: *****
Retype new SMB password: ****
Added user munki.
</code></pre>

<p>Now we need to share the munki_repo. Once &ldquo;smb.conf&rdquo; has loaded, add this to the very end of the file:<br />
<code>sudo nano /etc/samba/smb.conf</code></p>

<pre><code class="language-bash">
[munki_repo]
path = /usr/local/munki_repo
available = yes
valid users = munki      
read only = no
browseable = yes
public = no
writable = yes
</code></pre>

<p>Test for errors with the config file with: <code>testparm</code></p>

<p>Now we must restart samba.<br />
<code>sudo /etc/init.d/smbd reload</code></p>

<p>From your mac you will be able to access the munki_repo with the following: <code>smb://munki.example.com/munki_repo</code>.</p>

<h1 id="conclusion">Conclusion</h1>

<p>We now have a working munki_repo fully configured and ready for use to start importing packages into the repo. If you are really new to Munki, this takes care of the &ldquo;Demonstration Setup&rdquo; section from the <a href="https://github.com/munki/munki/wiki" target="_blank">munki wiki</a>. To start populating Munki with manifests, packages, and more I would recommend using <a href="https://github.com/hjuutilainen/munkiadmin" target="_blank">MunkiAdmin</a>.</p>

<hr />

<p>Articles:<br />
<a href="https://www.digitalocean.com/community/tutorials/how-to-configure-the-nginx-web-server-on-a-virtual-private-server" target="_blank">How to configure Nginx</a>,<br />
<a href="http://wiki.nginx.org/Configuration" target="_blank">Configuration - Official nginx documentation</a>,<br />
<a href="https://help.ubuntu.com/community/How%20to%20Create%20a%20Network%20Share%20Via%20Samba%20Via%20CLI%20(Command-line%20interface/Linux%20Terminal)%20-%20Uncomplicated,%20Simple%20and%20Brief%20Way!" target="_blank">Samba Setup</a>,<br />
<a href="https://www.digitalocean.com/community/tutorials/how-to-set-up-http-authentication-with-nginx-on-ubuntu-12-10" target="_blank">Basic Http Auth with Nginx</a>,</p>

</div>


  <footer class="container">
  <div class="container navigation no-print">
  <h2>Navigation</h2>
  
  

    
    <a class="prev" href="https://clburlison.com/reposado-guide/" title="Setup Reposado &#43; Margarita on Ubuntu 14.04">
      Previous
    </a>
    

    
    <a class="next" href="https://clburlison.com/munkirepo-guide-part-2/" title="Setup Mandrill on Ubuntu 14.04 - Part 2">
      Next
    </a>
    

  


</div>

  <div class="container comments">
  <h2>Comments</h2>
  
<div id="disqus_thread"></div>
<script type="text/javascript">
  (function() {
    
    
    if (window.location.hostname == "localhost")
      return;

    var dsq = document.createElement('script'); dsq.async = true; dsq.type = 'text/javascript';
    dsq.src = '//clburlison.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>


</div>

</footer>

</article>
      <footer id="main-footer" class="container main_footer">
  

  <div class="container nav foot no-print">
  

  <a class="toplink" href="#">back to top</a>

</div>

  <div class="container credits">
  
<div class="container footline">
  
  powered by <a href="https://gohugo.io/" target="_blank">Hugo</a>.


</div>


  
<div class="container copyright">
  
  &copy; 2014 - 2017 Clayton Burlison


</div>


</div>

</footer>

    </main>
    
<script type="text/javascript">
  (function() {
    
    
    if (window.location.hostname == "localhost")
      return;

    var dsq = document.createElement('script'); dsq.async = true; dsq.type = 'text/javascript';
    dsq.src = '//clburlison.disqus.com/count.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>



<script src="https://clburlison.com/js/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();</script>


    
  </body>
</html>

